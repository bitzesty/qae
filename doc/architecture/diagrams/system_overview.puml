@startuml KingsAwards for Enterprise System Overview
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_WITH_LEGEND()

title System Context diagram for Kings Awards for Enterprise (KAE)

Person(users, "Users", "People who interact with the KAE system")

System_Boundary(kae_system, "Kings Awards for Enterprise (KAE) System") {
    Container(kae_app, "KAE Application", "Ruby on Rails", "Main application for KAE")
    Container(kae_worker, "KAE Worker", "Sidekiq", "Background job processing")
    Container(poxa, "Poxa Websocket server", "Elixir", "Real-time communication")
    Container(vigilion, "Malware/AV Scanner", "Ruby", "File scanning service")
    ContainerDb(postgres, "PostgreSQL Database", "PostgreSQL", "Stores application data")
    ContainerDb(redis, "Redis Cache", "Redis", "Caching and job queue")
    ContainerDb(s3, "AWS S3 Bucket", "S3", "File storage")
}

System_Ext(cdn, "AWS CloudFront CDN", "Content Delivery Network")
System_Ext(notify, "GOV.UK Notify", "Email service")
System_Ext(appsignal, "Appsignal", "Monitoring and error reporting")

Rel(users, cdn, "Connects via", "HTTPS")
Rel(cdn, kae_app, "Fronts", "HTTPS")
Rel(cdn, poxa, "Fronts", "WebSocket")

Rel(kae_app, postgres, "Reads/Writes data", "SQL")
Rel(kae_app, redis, "Sends jobs", "Redis protocol")
Rel(kae_worker, redis, "Pulls jobs", "Redis protocol")
Rel(kae_app, s3, "Stores files", "HTTPS")
Rel(vigilion, s3, "Scans files", "HTTPS")
Rel(vigilion, kae_app, "Sends scan results", "API callback")

Rel(kae_app, notify, "Sends emails", "HTTPS")
Rel(kae_app, appsignal, "Reports errors and logs", "HTTPS")

@enduml